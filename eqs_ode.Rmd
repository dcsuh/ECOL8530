---
title: "eqs_ode"
author: "Daniel Suh"
date: "2/16/2021"
output: html_document
---

```{r, echo=F}
library(tidyverse)
library(magrittr)
library(deSolve)
library(here)
library(ggnewscale)
library(patchwork)
```

![compartmental diagram](concept.png)

Equations

$$
\begin{aligned}
 \frac{dS}{dt} &= -\beta_1 S I_k - \beta_2 S I_u - \phi \gamma - (1-\phi) \gamma (S/U) + \lambda - \mu S\\ \\
 \frac{dE}{dt} &=  \beta_1 S I_k + \beta_2 S I_u - \psi \theta E - (1-\psi) \theta E - (1-\phi) \gamma (E/U) - \mu E\\ \\
 \frac{dI_k}{dt} &= \psi \theta E - \alpha I_k - \mu I_k\\ \\
 \frac{dI_u}{dt} &= (1-\psi) \theta E - \alpha I_u - (1-\phi) \gamma (Iu/U) - \mu I_u\\ \\
 \frac{dR_k}{dt} &= \alpha I_k - \mu R_k\\ \\
 \frac{dR_u}{dt} &= \alpha I_u - (1-\phi) \gamma (Ru/U) - \mu R_u\\ \\
 \frac{dV}{dt} &= \gamma - \mu V\\ \\
\end{aligned}
$$
Parameters

$$
\begin{align*}
 & U = unknown\ immunity\ status\\ \\
 & \lambda = growth\ rate\\ \\
 & \mu = per\ capita\ mortality\ rate\\ \\
 & \beta = transmission\ rate\\ \\ 
 & \phi = antibody\ testing\ proportion\\ \\ 
 & \theta = incubation\ period\\ \\
 & \alpha = recovery\ rate\\ \\
 & \psi = detected\ cases\ proportion\\ \\
 & \gamma = daily\ vaccinations\\ \\
\end{align*}
$$

```{r, include=F}
#Grid search through parameters

data <- expand.grid(prop = seq(0,1,0.1), #proportion individuals in known infected class
                   inc = seq(1/7,1/4,(1/4-1/7)/4),
                   reco = seq(1/9,1/5,(1/5-1/9/4)),
                   mort1 = seq(1/(78.5*365),1/(78.5*365),0.5),
                   mort2 = seq(1/(77.5*365),1/(77.5*365),1/1000),
                   trans1 = seq(0.00003,0.0003,0.00003),
                   trans2 = seq(0.00003,0.0003,0.00003),
                   birth = seq(3924000,3924000,5))


mat <- matrix(1:9, nrow = 3, ncol = 3)


m <- nrow(data)

for(n in 1:m){
  mat[1] = 0
  mat[2] = (data$trans1[n]*data$birth[n])/(data$mort1[n]*(data$inc[n]+data$mort1[n]))
  mat[3] = (data$trans2[n]*data$birth[n])/(data$mort1[n]*(data$inc[n]+data$mort1[n]))
  mat[4] = (data$prop[n]*data$inc[n])/(data$reco[n]+data$mort2[n])
  mat[5] = 0
  mat[6] = 0
  mat[7] = ((1-data$prop[n])*data$inc[n])/(data$reco[n]+data$mort2[n])
  mat[8] = 0
  mat[9] = 0
  eigen <- max(eigen(mat)$values)
  data$eigen[n] <- eigen
}

data$trans3 <- data$trans1/data$trans2

data %>% ggplot(aes(x=prop,y=trans3,color=eigen))+geom_point()+scale_color_viridis_c(direction=-1)

#when prop is high, most infected individuals are in the Ik category
#trans1 is beta for Ik
#So if prop is high and trans3 is high then that should be the highest R0 because most individuals are Ik and Ik has higher beta in this case


```

```{r, eval=F}
#Grid search through parameters

data <- expand.grid(prop = seq(0,1,0.1), #proportion individuals in known infected class
                   inc = 1/5,
                   reco = 1/7,
                   mort1 = 1/1000,
                   mort2 = 1/100,
                   trans1 = 0.00003,
                   trans2 = 0.00003,
                   birth = 20)


mat <- matrix(1:9, nrow = 3, ncol = 3)

data %>% add_column(dfe = (data$lambda/data$mort1))

m <- nrow(data)

for(n in 1:m){
  mat[1] = 0
  mat[2] = (data$trans1[n])*(data$dfe[n])*(1/(data$inc[n]+data$mort1[n]))
  mat[3] = (data$trans2[n])*(data$dfe[n])*(1/(data$inc[n]+data$mort1[n]))
  mat[4] = (data$prop[n]*data$inc[n])/(data$reco[n]+data$mort2[n])
  mat[5] = 0
  mat[6] = 0
  mat[7] = ((1-data$prop[n])*data$inc[n])/(data$reco[n]+data$mort2[n])
  mat[8] = 0
  mat[9] = 0
  eigen <- max(eigen(mat)$values)
  data$eigen[n] <- eigen
}

data$trans3 <- data$trans1/data$trans2

data %>% ggplot(aes(x=prop,y=trans3,color=eigen))+geom_point()+scale_color_viridis_c(direction=-1)

#when prop is high, most infected individuals are in the Ik category
#trans1 is beta for Ik
#So if prop is high and trans3 is high then that should be the highest R0 because most individuals are Ik and Ik has higher beta in this case


```

ODE
Define functions and variables for deSolve
```{r, eval=F}
de<-function(t,x,params){
  S <- x[1]
  E <- x[2]
  Ik <- x[3]
  Iu <- x[4]
  Rk <- x[5]
  Ru <- x[6]
  V <- x[7]
  with(as.list(params),{
    dS <- -beta1*S*Ik - beta2*S*Iu - phi*gamma - (1-phi)*gamma*(S/(S+E+Iu+Ru)) + lambda - mu*S
    dE <- beta1*S*Ik + beta2*S*Iu - psi*theta*E - (1-psi)*theta*E - (1-phi)*gamma*(E/(S+E+Iu+Ru)) - mu*E
    dIk <- psi*theta*E - alpha*Ik - mu1*Ik
    dIu <- (1-psi)*theta*E - alpha*Iu - (1-phi)*gamma*(Iu/(S+E+Iu+Ru)) - mu1*Iu
    dRk <- alpha*Ik - mu*Rk
    dRu <- alpha*Iu - (1-phi)*gamma*(Ru/(S+E+Iu+Ru)) - mu*Ru
    dV <- gamma - mu*V
    res<-c(dS,dE,dIk,dIu,dRk,dRu,dV)
    list(res)
  })}
maxTime <- 100.0 # time
times<-seq(0,maxTime,by=0.1) # how often this calculates
# notes on params
# beta =      <- contact transmission rate
# lambda =    <- constant growth rate
# mu =        <- density-dependent mortality rate
# phi =       <- range: 0-1 proportion vaccines targeted to known susceptible individuals
# psi =       <- range: 0-1 probability infected individuals are identified
# alpha =     <- recovery rate
# gamma =     <- number of daily vaccines

params<-c(beta1=0.000003,
          beta2=0.00003,
          lambda=1/2,
          mu=1/10,
          mu1=1/5,
          phi=0.5,
          psi=0.3,
          theta=1/5,
          alpha=1/7,
          gamma=10000)  # model parameters

xstart<-c(S=5*10^6,
          E=1.6*10^5,
          Ik=1.3*10^5,
          Iu=4.9*10^5,
          Rk=6.6*10^5,
          Ru=2.7*10^6,
          V=0)  # initial conditions

# xstart<-c(S=175*10^6,
#           E=4.6*10^6,
#           Ik=3*10^6,
#           Iu=11.2*10^6,
#           Rk=22*10^6,
#           Ru=83*10^6,
#           V=0)  # initial conditions
```



```{r, eval=F}
psi_list <- c(80,50,20)
R0_list <- c(1.5,2,2.5)
final <- list()
for (i in 1:length(psi_list)){
  psi <- psi_list[i]
  R0_lines <- list()
  for (j in 1:length(R0_list)){
    R0 <- R0_list[j]
    threshold <- (1-1/R0)*as.numeric(xstart[1])
    phi <- c(0)
    time <- c(0)
    herd <- tibble(phi, time, .rows = 101)
    for (k in 0:100){
      params<-c(beta1=0.0000003,
                beta2=0.00000003,
                lambda=20,
                mu=1/1000,
                mu1=1/100,
                phi=k/100,
                psi=psi/100,
                theta=1/5,
                alpha=1/7,
                gamma=1*10^6) 
      output<-as.data.frame(lsoda(xstart,times,de,params)) # tells computer to solve (integrate) equations
      output$herd <- output$S<=threshold
      tmp <- output %>% filter(herd==1)
      herd$phi[k+1] <- as.numeric(params[6])
      herd$time[k+1] <- tmp$time[1]
    }
    R0_lines[[j]] <- herd
  }
  final[[i]] <- R0_lines
}
```


```{r, eval=F}
plot1 <- ggplot() + geom_line(data = final[[1]][[1]],aes(x=phi, y=time), color="red") +
  geom_line(data = final[[1]][[2]],aes(x=phi, y=time),color="forestgreen") +
  geom_line(data = final[[1]][[3]],aes(x=phi, y=time),color="blue") + 
  xlab("phi") + ylab("time") + labs(title = "80% symptomatic") +
  theme(axis.title.x = element_blank()) + ylim(0,10)

plot2 <- ggplot() + geom_line(data = final[[2]][[1]],aes(x=phi, y=time), color="red") +
  geom_line(data = final[[2]][[2]],aes(x=phi, y=time),color="forestgreen") +
  geom_line(data = final[[2]][[3]],aes(x=phi, y=time),color="blue") + 
  xlab("phi") + ylab("time") + labs(title = "50% symptomatic") + 
  theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y=element_blank()) + ylim(0,10)

plot3 <- ggplot() + geom_line(data = final[[3]][[1]],aes(x=phi, y=time), color="red") +
  geom_line(data = final[[3]][[2]],aes(x=phi, y=time),color="forestgreen") +
  geom_line(data = final[[3]][[3]],aes(x=phi, y=time),color="blue") + 
  xlab("phi") + ylab("time") + labs(title = "20% symptomatic") + 
  theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y=element_blank(), axis.title.x = element_blank()) + ylim(0,10)

final_plot <- plot1|plot2|plot3
final_plot
```

```{r, eval=F}
params<-c(beta1=0.00000003,
        beta2=0.00000003,
        lambda=20,
        mu=1/1000,
        mu1=1/100,
        phi=50/100,
        psi=50/100,
        theta=1/5,
        alpha=1/7,
        gamma=50000) 
R0 <- 2.5
threshold <- (1-1/R0)*as.numeric(xstart[1])
output<-as.data.frame(lsoda(xstart,times,de,params)) # tells computer to solve (integrate) equations

output %>% ggplot(.,aes(x=time))+
  geom_line(aes(y=S,col="Susceptible"))+
  geom_line(aes(y=E,col="Exposed"))+
  geom_line(aes(y=Ik,col="Infected_k"))+
  geom_line(aes(y=Iu,col="Infected_u"))+
  geom_line(aes(y=Rk,col="Recovered_k"))+
  geom_line(aes(y=Ru,col="Recovered_u"))+
  geom_line(aes(y=V,col="Vaccinated"))+
  scale_colour_manual(values = c("red","orange","hotpink","green","blue","purple","gray","black"))+
  #theme(legend.position = c(0.75,0.4))+
  labs(y="N",x="Time",col="Population")+
  #ggtitle("Transmission Model for Antibody-Assisted Vaccinations")+
  theme(plot.title = element_text(hjust=, size=10))+
  geom_hline(yintercept=threshold)+
  xlim(0,100)+ylim(0,as.numeric(xstart[1]))
```


```{r, eval=F}
params<-c(beta1=0.0000003,#transmission rate for known infecteds
        beta2=0.000003,#transmission rate for unknown infecteds
        lambda=5,
        mu=1/1000,
        mu1=1/10,
        phi=10/100,#proportion vaccines going to confirmed susceptibles
        psi=80/100,#proportion of infecteds in known category
        theta=1,
        alpha=1/7,
        gamma=2500)   # model parameters

output<-as.data.frame(lsoda(xstart,times,de,params)) # tells computer to solve (integrate) equations

output %>% ggplot(.,aes(x=time))+
  geom_line(aes(y=S,col="Susceptible"))+
  geom_line(aes(y=E,col="Exposed"))+
  geom_line(aes(y=Ik,col="Infected_k"))+
  geom_line(aes(y=Iu,col="Infected_u"))+
  geom_line(aes(y=Rk,col="Recovered_k"))+
  geom_line(aes(y=Ru,col="Recovered_u"))+
  geom_line(aes(y=V,col="Vaccinated"))+
  scale_colour_manual(values = c("red","orange","hotpink","green","blue","purple","gray","black"))+
  #theme(legend.position = c(0.75,0.4))+
  labs(y="N",x="Time",col="Population")+
  #ggtitle("Transmission Model for Antibody-Assisted Vaccinations")+
  theme(plot.title = element_text(hjust=, size=10))+
  geom_hline(yintercept=2*10^5)+
  xlim(0,100)+ylim(0,500000)
```


```{r, eval=F}
params<-c(beta1=0.0000003,#transmission rate for known infecteds
        beta2=0.000003,#transmission rate for unknown infecteds
        lambda=5,
        mu=1/1000,
        mu1=1/10,
        phi=10/100,#proportion vaccines going to confirmed susceptibles
        psi=20/100,#proportion of infecteds in known category
        theta=1,
        alpha=1/7,
        gamma=2500)   # model parameters

output<-as.data.frame(lsoda(xstart,times,de,params)) # tells computer to solve (integrate) equations

output %>% ggplot(.,aes(x=time))+
  geom_line(aes(y=S,col="Susceptible"))+
  geom_line(aes(y=E,col="Exposed"))+
  geom_line(aes(y=Ik,col="Infected_k"))+
  geom_line(aes(y=Iu,col="Infected_u"))+
  geom_line(aes(y=Rk,col="Recovered_k"))+
  geom_line(aes(y=Ru,col="Recovered_u"))+
  geom_line(aes(y=V,col="Vaccinated"))+
  scale_colour_manual(values = c("red","orange","hotpink","green","blue","purple","gray","black"))+
  #theme(legend.position = c(0.75,0.4))+
  labs(y="N",x="Time",col="Population")+
  #ggtitle("Transmission Model for Antibody-Assisted Vaccinations")+
  theme(plot.title = element_text(hjust=, size=10))+
  geom_hline(yintercept=2*10^5)+
  xlim(0,100)+ylim(0,500000)
```

```{r, eval=F}
params<-c(beta1=0.0000003,#transmission rate for known infecteds
        beta2=0.000003,#transmission rate for unknown infecteds
        lambda=5,
        mu=1/1000,
        mu1=1/10,
        phi=90/100,#proportion vaccines going to confirmed susceptibles
        psi=20/100,#proportion of infecteds in known category
        theta=1,
        alpha=1/7,
        gamma=2500)   # model parameters

output<-as.data.frame(lsoda(xstart,times,de,params)) # tells computer to solve (integrate) equations

output %>% ggplot(.,aes(x=time))+
  geom_line(aes(y=S,col="Susceptible"))+
  geom_line(aes(y=E,col="Exposed"))+
  geom_line(aes(y=Ik,col="Infected_k"))+
  geom_line(aes(y=Iu,col="Infected_u"))+
  geom_line(aes(y=Rk,col="Recovered_k"))+
  geom_line(aes(y=Ru,col="Recovered_u"))+
  geom_line(aes(y=V,col="Vaccinated"))+
  scale_colour_manual(values = c("red","orange","hotpink","green","blue","purple","gray","black"))+
  #theme(legend.position = c(0.75,0.4))+
  labs(y="N",x="Time",col="Population")+
  #ggtitle("Transmission Model for Antibody-Assisted Vaccinations")+
  theme(plot.title = element_text(hjust=, size=10))+
  geom_hline(yintercept=2*10^5)+
  xlim(0,100)+ylim(0,500000)
```

```{r, eval=F}
params<-c(beta1=0.0000003,#transmission rate for known infecteds
        beta2=0.000003,#transmission rate for unknown infecteds
        lambda=5,
        mu=1/1000,
        mu1=1/10,
        phi=90/100,#proportion vaccines going to confirmed susceptibles
        psi=80/100,#proportion of infecteds in known category
        theta=1,
        alpha=1/7,
        gamma=2500)   # model parameters

output<-as.data.frame(lsoda(xstart,times,de,params)) # tells computer to solve (integrate) equations

output %>% ggplot(.,aes(x=time))+
  geom_line(aes(y=S,col="Susceptible"))+
  geom_line(aes(y=E,col="Exposed"))+
  geom_line(aes(y=Ik,col="Infected_k"))+
  geom_line(aes(y=Iu,col="Infected_u"))+
  geom_line(aes(y=Rk,col="Recovered_k"))+
  geom_line(aes(y=Ru,col="Recovered_u"))+
  geom_line(aes(y=V,col="Vaccinated"))+
  scale_colour_manual(values = c("red","orange","hotpink","green","blue","purple","gray","black"))+
  #theme(legend.position = c(0.75,0.4))+
  labs(y="N",x="Time",col="Population")+
  #ggtitle("Transmission Model for Antibody-Assisted Vaccinations")+
  theme(plot.title = element_text(hjust=, size=10))+
  geom_hline(yintercept=2*10^5)+
  xlim(0,100)+ylim(0,500000)
```

```{r, eval=F}
params<-c(beta1=0.0000003,#transmission rate for known infecteds
        beta2=0.000003,#transmission rate for unknown infecteds
        lambda=5,
        mu=1/1000,
        mu1=1/10,
        phi=20/100,#proportion vaccines going to confirmed susceptibles
        psi=20/100,#proportion of infecteds in known category
        theta=1,
        alpha=1/7,
        gamma=2500)   # model parameters

output<-as.data.frame(lsoda(xstart,times,de,params)) # tells computer to solve (integrate) equations

output %>% ggplot(.,aes(x=time))+
  geom_line(aes(y=S,col="Susceptible"))+
  geom_line(aes(y=E,col="Exposed"))+
  geom_line(aes(y=Ik,col="Infected_k"))+
  geom_line(aes(y=Iu,col="Infected_u"))+
  geom_line(aes(y=Rk,col="Recovered_k"))+
  geom_line(aes(y=Ru,col="Recovered_u"))+
  geom_line(aes(y=V,col="Vaccinated"))+
  scale_colour_manual(values = c("red","orange","hotpink","green","blue","purple","gray","black"))+
  #theme(legend.position = c(0.75,0.4))+
  labs(y="N",x="Time",col="Population")+
  #ggtitle("Transmission Model for Antibody-Assisted Vaccinations")+
  theme(plot.title = element_text(hjust=, size=10))+
  geom_hline(yintercept=2*10^5)+
  xlim(0,100)+ylim(0,500000)
```

```{r, eval=F}
params<-c(beta1=0.0000003,#transmission rate for known infecteds
        beta2=0.000003,#transmission rate for unknown infecteds
        lambda=5,
        mu=1/1000,
        mu1=1/10,
        phi=20/100,#proportion vaccines going to confirmed susceptibles
        psi=80/100,#proportion of infecteds in known category
        theta=1,
        alpha=1/7,
        gamma=2500)   # model parameters

output<-as.data.frame(lsoda(xstart,times,de,params)) # tells computer to solve (integrate) equations

output %>% ggplot(.,aes(x=time))+
  geom_line(aes(y=S,col="Susceptible"))+
  geom_line(aes(y=E,col="Exposed"))+
  geom_line(aes(y=Ik,col="Infected_k"))+
  geom_line(aes(y=Iu,col="Infected_u"))+
  geom_line(aes(y=Rk,col="Recovered_k"))+
  geom_line(aes(y=Ru,col="Recovered_u"))+
  geom_line(aes(y=V,col="Vaccinated"))+
  scale_colour_manual(values = c("red","orange","hotpink","green","blue","purple","gray","black"))+
  #theme(legend.position = c(0.75,0.4))+
  labs(y="N",x="Time",col="Population")+
  #ggtitle("Transmission Model for Antibody-Assisted Vaccinations")+
  theme(plot.title = element_text(hjust=, size=10))+
  geom_hline(yintercept=2*10^5)+
  xlim(0,100)+ylim(0,500000)
```